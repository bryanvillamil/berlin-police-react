import { useState, useMemo, useEffect } from "react";
import { useQuery } from 'react-query' 
import Head from "next/head";
import { SubmitHandler } from "react-hook-form";
import { LayoutBikes, Header, FormSearch, BoxBike, Pagination, NotFound, Loading, CountBikes } from "@components";
import { useBikes, api } from "@services";
import { locationEnum, FormFields } from "@types";
import { WrapperBikesInfo } from "../styles/styled";

const Home = () => {
  const [page, setPage] = useState(1);
  const [count, setCount] = useState(0);
  const [dataFilters, setDataFilters] = useState<Partial<FormFields>>({
    search: "",
    location: locationEnum.berlin
  });  

  const { refetch: refetchCount, isFetching } = useQuery(
    'bikesCount',
    () => api.get(`/search/count?location=${dataFilters.location}&stolenness=proximity`)
      .then(res => {
        setCount(res.data.proximity);
      })
  )

  const { data, isLoading, error } = useBikes({
    query: dataFilters.search,
    location: dataFilters.location,
    stolenness: 'proximity',
    distance: 10,
    page,
    per_page: 10,
  });

  const bikes = data?.pages[0].bikes;

  const memoriesDataBikes = useMemo(() => {
    
    if (!bikes) {
      return [];
    }

    if (dataFilters && dataFilters.dateFrom && dataFilters.dateTo) {
      const startDate = new Date(dataFilters.dateFrom);
      const endDate = new Date(dataFilters.dateTo);

      return bikes.filter((bike) => {
        const startParse = startDate.getTime() / 1000;
        const endParse = endDate.getTime() / 1000;

        return (
          bike.date_stolen <= endParse &&
          bike.date_stolen >= startParse
        );
      });
    }

    return bikes;
  }, [bikes, dataFilters]);

  useEffect(() => {
    refetchCount();
  }, [dataFilters.location, refetchCount])


  const onSubmit: SubmitHandler<FormFields> = (dataRes) => {
    setDataFilters(dataRes);
    setPage(1)
  };

  if (error) return "Oooops, Something went wrong!!!";

  return (
    <>
      <Head>
        <title>Stolen Bikes</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Header city={dataFilters?.location} />

      <LayoutBikes>
        <FormSearch onSubmit={onSubmit} />


        <WrapperBikesInfo>
          <CountBikes isLoading={isFetching} dataCount={count} />
          {isLoading
            ? <Loading />
            : memoriesDataBikes.length == 0 ? (
              <NotFound />
            ) : 
              memoriesDataBikes.map((bike) => {
                const titleFull = 
                  `${bike.title} ${bike.frame_colors && `(${bike.frame_colors.join()})`}`;
                return (
                  <BoxBike
                    key={bike.id}
                    description={bike.description ? bike.description : ""}
                    title={titleFull}
                    large_img={bike.large_img}
                    stolen_location={bike.stolen_location}
                    date_stolen={bike.date_stolen}
                  />
                );
              }
            )
          }
        </WrapperBikesInfo>

        <Pagination 
          page={page} 
          setPage={setPage} 
          disabled={memoriesDataBikes.length == 0}
        />
      </LayoutBikes>
    </>
  );
};

export default Home;